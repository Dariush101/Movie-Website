<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login - ReelDeal Cinema</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');

* { font-family: 'Inter', sans-serif; margin: 0; padding: 0; box-sizing: border-box; }

body {
    min-height: 100vh;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
}

body::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: 
        radial-gradient(circle at 20% 50%, rgba(120,119,198,0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(255,138,101,0.3) 0%, transparent 50%),
        radial-gradient(circle at 40% 20%, rgba(74,144,226,0.3) 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
}

.login-card {
    position: relative;
    z-index: 10;
    width: 100%;
    max-width: 400px;
    padding: 3rem;
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(20px);
    border-radius: 2rem;
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    animation: fadeIn 0.8s ease-in;
}

.login-card h1 {
    font-size: 2.8rem;
    font-weight: 800;
    text-align: center;
    margin-bottom: 1rem;
    background: linear-gradient(135deg, #4a90e2, #ff8a65);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.login-card p {
    text-align: center;
    margin-bottom: 2rem;
    color: rgba(255,255,255,0.8);
}

form#loginForm {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

input {
    width: 100%;
    padding: 2rem 1rem;
    font-size: 1.2rem;
    border-radius: 1.5rem;
    border: none;
    background: rgba(255,255,255,0.15);
    color: white;
    backdrop-filter: blur(10px);
    text-indent: 7px;
    transition: all 0.3s;
}

input:focus {
    outline: none;
    box-shadow: 0 0 15px #4a90e2;
    border: 2px solid #4a90e2;
}

.btn-gradient {
    width: 100%;
    padding: 0.75rem;
    border-radius: 1rem;
    background: linear-gradient(135deg, #4a90e2, #ff8a65);
    border: none;
    color: white;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 8px 20px rgba(74,144,226,0.5);
}

.btn-gradient:hover {
    transform: translateY(-2px) scale(1.02);
    box-shadow: 0 15px 35px rgba(74,144,226,0.6);
}

.toggle-checkbox {
    position: relative;
    display: inline-block;
    width: 42px;
    height: 22px;
    margin-right: 0.5rem;
}

.toggle-checkbox input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: rgba(255,255,255,0.3);
    border-radius: 34px;
    transition: 0.4s;
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 2px;
    bottom: 2px;
    background-color: white;
    border-radius: 50%;
    transition: 0.4s;
}

.toggle-checkbox input:checked + .toggle-slider {
    background: #4a90e2;
}

.toggle-checkbox input:checked + .toggle-slider:before {
    transform: translateX(20px);
}

.forgot-link {
    color: white;
    text-decoration: underline;
    cursor: pointer;
    transition: all 0.3s;
}

.forgot-link:hover {
    color: #4a90e2;
    text-decoration: none;
}

.register-btn {
    display: inline-block;
    margin-top: 1rem;
    width: 100%;
    text-align: center;
    padding: 0.75rem;
    border-radius: 1rem;
    background: linear-gradient(135deg, #ff8a65, #4a90e2);
    color: white;
    font-weight: bold;
    text-decoration: none;
    transition: all 0.3s;
}

.register-btn:hover {
    transform: translateY(-2px) scale(1.02);
    box-shadow: 0 12px 30px rgba(74,144,226,0.5);
}

footer {
    text-align: center;
    padding: 1rem;
    color: #aaa;
    font-size: 0.85rem;
    position: absolute;
    bottom: 0;
    width: 100%;
}

#successMessage, #errorMessage {
    border-radius: 1rem;
    text-align: center;
    padding: 0.75rem;
    margin-bottom: 1rem;
}

#successMessage { background: rgba(0,128,0,0.5); color: #b6f6b6; }
#errorMessage { background: rgba(255,0,0,0.5); color: #ffb6b6; }

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>
</head>
<body>
<div class="login-card">
    <h1>Welcome Back</h1>
    <p>Sign in to book your favorite movies</p>

    <div id="successMessage" class="hidden">Login successful!</div>
    <div id="errorMessage" class="hidden"></div>

    <form id="loginForm">
        <input type="email" id="email" placeholder="Email" required>
        <input type="password" id="password" placeholder="Password" required>

        <div class="flex justify-between mb-4 items-center text-sm">
            <label class="flex items-center">
                <span class="toggle-checkbox">
                    <input type="checkbox" id="remember-me">
                    <span class="toggle-slider"></span>
                </span>
                Remember me
            </label>
            <a href="forgot.html" class="forgot-link">Forgot password?</a>
        </div>

        <div class="mb-4">
            <button type="button" id="adminToggle" class="w-full py-2 px-4 rounded-lg bg-purple-600/30 border border-purple-400/50 text-white text-sm font-semibold hover:bg-purple-600/50 transition">
                üîê Admin Login?
            </button>
        </div>

        <div id="adminCodeField" class="hidden mb-4">
            <input type="password" id="adminCode" placeholder="Enter Admin Code" style="background: rgba(138,43,226,0.2); border: 2px solid rgba(138,43,226,0.5);">
            <p class="text-xs text-purple-300 mt-2 text-center">Enter your admin access code to continue</p>
        </div>

        <a href="Home_Screen.html" class="register-btn">Sign In</a>

    </form>

    <a href="register.html" class="register-btn">Register here</a>
</div>

<footer>
    &copy; 2024 ReelDeal Cinema. All rights reserved.
</footer>

<script>
// Initialize storage compatibility layer
function initializeStorage() {
    if (!window.storage) {
        window.storage = {
            async get(key) {
                const item = localStorage.getItem(key);
                return item ? { key, value: item } : null;
            },
            async set(key, value) {
                localStorage.setItem(key, value);
                return { key, value };
            },
            async delete(key) {
                localStorage.removeItem(key);
                return { key, deleted: true };
            },
            async list(prefix) {
                const keys = Object.keys(localStorage).filter(k => !prefix || k.startsWith(prefix));
                return { keys };
            }
        };
    }
}

// Hash password function
function hashPassword(password) {
    return CryptoJS.SHA256(password).toString();
}

// Show error message
function showError(msg) {
    const errorBox = document.getElementById("errorMessage");
    errorBox.textContent = msg;
    errorBox.classList.remove("hidden");
    document.getElementById("successMessage").classList.add("hidden");
}

// Show success message
function showSuccess(msg) {
    const successBox = document.getElementById("successMessage");
    successBox.textContent = msg;
    successBox.classList.remove("hidden");
    document.getElementById("errorMessage").classList.add("hidden");
}

// Toggle admin code field
document.getElementById('adminToggle').addEventListener('click', function() {
    const adminCodeField = document.getElementById('adminCodeField');
    const isHidden = adminCodeField.classList.contains('hidden');
    
    if (isHidden) {
        adminCodeField.classList.remove('hidden');
        this.textContent = 'üë§ Regular Login?';
        this.style.background = 'rgba(74,144,226,0.3)';
    } else {
        adminCodeField.classList.add('hidden');
        this.textContent = 'üîê Admin Login?';
        this.style.background = 'rgba(138,43,226,0.3)';
        document.getElementById('adminCode').value = '';
    }
});

// LOGIN HANDLER
document.getElementById("loginForm").addEventListener("submit", async function (e) {
    e.preventDefault();
    initializeStorage();

    const email = document.getElementById("email").value.trim().toLowerCase();
    const password = document.getElementById("password").value;
    const rememberMe = document.getElementById("remember-me").checked;
    const adminCodeField = document.getElementById('adminCodeField');
    const isAdminLogin = !adminCodeField.classList.contains('hidden');
    const adminCode = document.getElementById('adminCode').value;

    if (!email || !password) {
        return showError("Please fill in all fields.");
    }

    // If admin login is selected, validate admin code
    if (isAdminLogin && !adminCode) {
        return showError("Please enter the admin code.");
    }

    try {
        // Get user ID from email mapping
        const emailResult = await window.storage.get(`user_email:${email}`);
        
        if (!emailResult) {
            return showError("Email not found. Please register first.");
        }

        const userId = emailResult.value;

        // Load user object
        const userResult = await window.storage.get(`user:${userId}`);

        if (!userResult) {
            return showError("User record not found. Please contact support.");
        }

        const user = JSON.parse(userResult.value);

        // Verify password
        const passwordHash = hashPassword(password);

        if (passwordHash !== user.passwordHash) {
            return showError("Incorrect password. Please try again.");
        }

        // If admin login is attempted, verify the code and account type
        if (isAdminLogin) {
            if (adminCode !== 'ADMIN2025') {
                return showError("Invalid admin code!");
            }
            if (user.accountType !== 'admin') {
                return showError("This account does not have admin privileges.");
            }
        }

        // Create session
        const session = {
            userId: user.userId,
            email: user.email,
            name: user.name,
            accountType: user.accountType,
            loggedIn: true,
            loginTime: new Date().toISOString()
        };

        await window.storage.set('currentUser', JSON.stringify(session));

        // Remember me functionality
        if (rememberMe) {
            await window.storage.set('rememberedUser', email);
        } else {
            await window.storage.delete('rememberedUser');
        }

        // Show success message
        const greeting = isAdminLogin ? `Welcome Admin ${user.name}!` : `Welcome back, ${user.name}!`;
        showSuccess(greeting);

        // Redirect based on login type
        setTimeout(() => {
            if (isAdminLogin && user.accountType === 'admin') {
                window.location.href = 'admin.html';
            } else {
                window.location.href = 'home.html';
            }
        }, 1000);

    } catch (err) {
        console.error('Login error:', err);
        showError("An error occurred during login. Please try again.");
    }
});

// Auto-fill remembered email on page load
window.addEventListener('DOMContentLoaded', async () => {
    initializeStorage();
    try {
        const remembered = await window.storage.get('rememberedUser');
        if (remembered) {
            document.getElementById('email').value = remembered.value;
            document.getElementById('remember-me').checked = true;
        }
    } catch (err) {
        console.error('Error loading remembered user:', err);
    }
});

initializeStorage();
</script>

</body>
</html>